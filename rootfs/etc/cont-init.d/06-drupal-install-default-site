#!/usr/bin/execlineb -P
# -*- mode: sh -*-
# vi: set ft=sh:
with-contenv
multisubstitute
{
  define MYSQL_HOST localhost
  define MYSQL_HOST_PORT 3306
  import -i MYSQL_ROOT_USER
  import -i MYSQL_ROOT_PASSWORD
  import -i DRUPAL_ROOT
  import -i DRUPAL_SITE_INSTALL_PROFILE
  import -i DRUPAL_SITE_NAME
  import -i DRUPAL_SITE_EMAIL
  import -i DRUPAL_SITE_LOCALE
  import -i DRUPAL_SITE_ACCOUNT_USER
  import -i DRUPAL_SITE_ACCOUNT_PASSWORD
  import -i DRUPAL_SITE_ACCOUNT_EMAIL
  import -i DRUPAL_SITE_DB_NAME
  import -i DRUPAL_SITE_DB_USER
  import -i DRUPAL_SITE_DB_PASSWORD
  import -i DRUPAL_SITE_DB_REPLACE_EXISTING
  import -i DRUPAL_SITE_DB_IMPORT
}
# Start MySQL service
background { s6-setuidgid mysql mysqld --skip-networking }
importas MYSQLD_PID !
# Wait for MySQL service to be ready.
foreground {
  loopwhilex -x 0
  redirfd -w 1 /dev/null
  redirfd -w 2 /dev/null
  mysql --protocol=socket -u ${MYSQL_ROOT_USER} --password=${MYSQL_ROOT_PASSWORD} -e "SELECT 1"
}
# Check if the Database is already populated with tables.
backtick -ni DRUPAL_SITE_DB_TABLES {
  mysql
  --user=${MYSQL_ROOT_USER} --password=${MYSQL_ROOT_PASSWORD}
  -Ne "SELECT COUNT(DISTINCT `table_name`)
       FROM `information_schema`.`columns`
       WHERE `table_schema` = '${DRUPAL_SITE_DB_NAME}'"
}
multisubstitute
{
  import -u DRUPAL_SITE_DB_TABLES
}
foreground {
  # Only install if Database is not populated or if the variable
  # $DRUPAL_SITE_DB_REPLACE_EXISTING has been explicitly set.
  ifelse { s6-test $DRUPAL_SITE_DB_TABLES -eq 0 -o $DRUPAL_SITE_DB_REPLACE_EXISTING = "yes" } {
    # Decompress Database Dump.
    foreground {
      echo "Installing Drupal."
    }
    foreground {
      ifelse { s6-test -e /assets/${DRUPAL_SITE_DB_NAME}.sql.gz } {
        cd /assets gunzip ${DRUPAL_SITE_DB_NAME}.sql.gz
      } echo "No Drupal database dump to decompress."
    }
    # Import Database Dump.
    foreground {
      ifelse { s6-test -e /assets/${DRUPAL_SITE_DB_NAME}.sql -a $DRUPAL_SITE_DB_IMPORT = "yes" } {
        redirfd -r 0 /assets/${DRUPAL_SITE_DB_NAME}.sql
        mysql --user=$MYSQL_ROOT_USER --password="${MYSQL_ROOT_PASSWORD}" ${DRUPAL_SITE_DB_NAME}
      }
      # Default install when no database was imported.
      # Install the site, using the standard profile
      # and don't send a e-mail notification.
      cd /var/www/html s6-setuidgid www-data drush -y si
      $DRUPAL_SITE_INSTALL_PROFILE install_configure_form.update_status_module='array(FALSE,FALSE)'
      --sites-subdir=default
      --site-name="${DRUPAL_SITE_NAME}"
      --site-mail="${DRUPAL_SITE_EMAIL}"
      --locale="${DRUPAL_SITE_LOCALE}"
      --account-name="${DRUPAL_SITE_ACCOUNT_USER}"
      --account-pass="${DRUPAL_SITE_ACCOUNT_PASSWORD}"
      --account-mail="${DRUPAL_SITE_ACCOUNT_EMAIL}"
      --db-url="mysql://${DRUPAL_SITE_DB_USER}:${DRUPAL_SITE_DB_PASSWORD}@${MYSQL_HOST}:${MYSQL_HOST_PORT}/${DRUPAL_SITE_DB_NAME}"
      --db-su="${MYSQL_ROOT_USER}" --db-su-pw="${MYSQL_ROOT_PASSWORD}"
    }
  } echo "Drupal already Installed."
}
foreground {
  cd $DRUPAL_ROOT s6-setuidgid www-data drush sqlq "update users set name='${DRUPAL_SITE_ACCOUNT_USER}', mail='${DRUPAL_SITE_ACCOUNT_EMAIL}' where uid=1;"
}
foreground {
  cd $DRUPAL_ROOT s6-setuidgid www-data drush user-password 1 --password=${DRUPAL_SITE_ACCOUNT_PASSWORD}
}
foreground {
  cd $DRUPAL_ROOT s6-setuidgid www-data drush -y en features
}
foreground {
  cd $DRUPAL_ROOT s6-setuidgid www-data drush features-revert-all -y
}
foreground {
  cd $DRUPAL_ROOT s6-setuidgid www-data drush cc all
}
foreground {
  chown -R www-data:www-data $DRUPAL_ROOT
}
# Kill MySQL Service and wait for it to shutdown.
foreground {
  kill -s TERM $MYSQLD_PID
} sleep 5
