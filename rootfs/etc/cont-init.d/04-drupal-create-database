#!/usr/bin/execlineb -P
# -*- mode: sh -*-
# vi: set ft=sh:
with-contenv
multisubstitute
{
  import -i MYSQL_ROOT_USER
  import -i MYSQL_ROOT_PASSWORD
  import -i DRUPAL_SITE_DB_NAME
  import -i DRUPAL_SITE_DB_USER
  import -i DRUPAL_SITE_DB_PASSWORD
}
# Start MySQL service.
background { s6-setuidgid mysql mysqld --skip-networking }
importas MYSQLD_PID !
# Wait for MySQL service to be ready.
foreground {
  loopwhilex -x 0
  redirfd -w 1 /dev/null
  redirfd -w 2 /dev/null
  mysql --protocol=socket
  --user ${MYSQL_ROOT_USER} --password=${MYSQL_ROOT_PASSWORD}
  -e "SELECT 1"
}
foreground {
  # Only create the database and user for Drupal if the database does not already
  # exist.
  ifelse -n {
    redirfd -w 2 /dev/null
    mysql
    --user=${MYSQL_ROOT_USER} --password=${MYSQL_ROOT_PASSWORD}
    -e use ${DRUPAL_SITE_DB_NAME}
  }
  {
    redirfd -w 2 /dev/null
    mysql
    --user=${MYSQL_ROOT_USER} --password=${MYSQL_ROOT_PASSWORD}
    -e "CREATE USER '${DRUPAL_SITE_DB_USER}'@'localhost' IDENTIFIED BY '${DRUPAL_SITE_DB_PASSWORD}';
        CREATE DATABASE ${DRUPAL_SITE_DB_NAME};
        GRANT ALL ON ${DRUPAL_SITE_DB_NAME}.* TO '${DRUPAL_SITE_DB_USER}'@'localhost';"
  }
  # Otherwise just update the users password.
  redirfd -w 2 /dev/null
  mysql
  --user=${MYSQL_ROOT_USER} --password=${MYSQL_ROOT_PASSWORD}
  -e "SET PASSWORD FOR '${DRUPAL_DB_USER}'@'localhost' = PASSWORD('${DRUPAL_DB_PASSWORD}');"
}
# Stop MySQL Service.
foreground {
  kill -s TERM $MYSQLD_PID
} sleep 5
